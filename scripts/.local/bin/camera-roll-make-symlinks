#!/usr/bin/env python3
from pathlib import Path
import configparser
import argparse
import glob
import sys
import os


class CameraRoll:
    def __init__(self, id: str, target_dir: Path):
        self.id: str = id
        self.target_dir: Path = target_dir
        self.src_folders: set[Path] = set()

    def add_src(self, folder: Path):
        self.src_folders.add(folder)

    def make_links(self, dry_run: bool = False, verbose: bool = False) -> int:
        if not dry_run:
            self.target_dir.mkdir(parents=True, exist_ok=True)

        count: int = 0
        for folder in self.src_folders:
            files = [p for p in map(Path, glob.glob(str(folder) + '/*')) if p.is_file()]
            count += len(files)

            for file in files:
                link = self.target_dir / file.name

                if verbose:
                    print(f"{link} => {file}")

                if not dry_run:
                    if link.is_symlink():
                        link.unlink()
                    link.symlink_to(file.absolute().relative_to(self.target_dir.absolute(), walk_up=True))

        return count


def check_exclusions(path: Path, exclusions: list[Path]):
    return any(Path(os.path.abspath(path)).is_relative_to(os.path.abspath(x)) for x in exclusions)


def main():
    parser = argparse.ArgumentParser(
        prog="camera-roll-make-symlinks"
    )

    parser.add_argument("library_root", help="Root directory of the photos library to scan", type=Path)
    parser.add_argument("camera_rolls_dir", help="Directory where the symlinked camera rolls will be created. Must contain camera-rolls.ini", type=Path)
    parser.add_argument("-x", "--exclude", default=[], action="extend", nargs=1, help="Exclude folder from recursive search", type=Path)
    parser.add_argument("-n", "--dry-run", default=False, action="store_true", help="Dry run, don't make links")
    parser.add_argument("-v", "--verbose", default=False, action="store_true", help="Print what would be done")
    args = parser.parse_args()

    args.exclude.append(args.camera_rolls_dir)

    config = configparser.ConfigParser()
    config.read(args.camera_rolls_dir / 'camera-rolls.ini')

    camera_rolls: dict[str, CameraRoll] = {}

    for camera_roll_id in config.sections():
        camera_rolls[camera_roll_id] = CameraRoll(
            id=camera_roll_id,
            target_dir=args.camera_rolls_dir / Path(config[camera_roll_id].get('target', camera_roll_id)),
        )

    # Find .camera-roll files
    dot_camera_roll_files = map(Path, glob.glob(str(args.library_root) + "/**/.camera-roll", recursive=True))
    for f in dot_camera_roll_files:
        # Check for excluded directories
        if check_exclusions(f, args.exclude):
            continue

        camera_roll_id = open(f).read().strip()
        if not camera_roll_id in camera_rolls:
            print(f"'{f}': camera roll '{camera_roll_id}' not defined in config file. Ignoring", file=sys.stderr)
            continue
        camera_rolls[camera_roll_id].add_src(f.parent)

    # Find directories named after camera roll ids
    for camera_roll in camera_rolls.values():
        direcories = map(Path, glob.glob(str(args.library_root) + f"/**/{camera_roll.id}", recursive=True))

        for dir in direcories:
            # Check for excluded directories
            if check_exclusions(dir, args.exclude):
                continue
            camera_roll.add_src(dir)

    # Make links
    stats: dict[str, int] = {}
    for camera_roll in camera_rolls.values():
        stats[camera_roll.id] = camera_roll.make_links(dry_run = args.dry_run, verbose = args.verbose)

    for camera_roll_id, count in stats.items():
        print(f"{camera_roll_id}: {count} items")


if __name__ == '__main__':
    main()
